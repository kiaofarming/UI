<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"
        integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="container">
        <nav class="nav-box">
            <input type="checkbox" id="menu">
            <label for="menu" class="line">
                <div class="menu"></div>
            </label>

            <div class="menu-list">
                <ul>
                    <li id="show" class="add">+ 新增控制器</li>
                    <li class="use">調光LED燈</li>
                    <li class="unuse">未啟動</li>
            </div>
        </nav>

        <div class="header">
            <div class="column">
                <h3 id="submit">調光LED燈</h3>

            </div>
        </div>

        <div id="zone" class="button">
            <h3 style="text-align: left;margin-left: 60px;">開關狀態</h3>
            <div id="switch">
                <div class="flex-container">
                    <div id="bt1" class="zone-btn">
                        <h4>風扇</h4>

                        <span id="state" style="text-align: center;">OFF</span>
                    </div>
                    <div id="bt2" class="zone-btn">

                        <h4>灑水</h4>

                        <span id="state2" style="text-align: center;">OFF</span>
                    </div>
                </div>
            </div>
        </div>
        <dialog id="infoModal">



            <div>

                <label>設備名稱 <input type="text" /></label>
                <label>SSID <input type="text" /></label>
                <label>DeviceID <input type="text" /></label>
                <label>第1路開關名稱 <input type="text" /></label>
                <br>
                <label>第2路開關名稱 <input type="text" /></label>

                <div id="valid_msg"></div>


                <div class="buttons">
                    <div id="close" class="cancelBtn">關閉</div>
                </div>
        </dialog>

    </div>

</body>

<script language="JavaScript"></script>
<script>
    //** 按下設備開關後，發送命令給伺服端( set_switch() )*//
    const API_HOST = "https://mqtt.kiaofarming.com";
    const API_VER = "v1";

    const ATTR_DISABLED = "disabled";

    function set_switch(dev_id, port, sw, cb) {
        let req_data = {};
        req_data[`port${port}`] = sw;

        $.ajax({
            url: `${API_HOST}/${API_VER}/controller/switch/${dev_id}`,
            method: "POST",
            contentType: "application/x-www-form-urlencoded",
            headers: {
                "Authorization": "Bearer {nTqOrlSptF156qc26duTSQhmuWFVA2RCeLCRRaenTb2}",
            },
            dataType: "json",
            data: req_data
        }).done(resp_data => {
            cb(resp_data);
        });
    }
    function get_device_id_validity(dev_id, ssid, cb) {
        let req_data = {};
        req_data["device_id"] = dev_id;
        req_data["ssid"] = ssid;

        $.ajax({
            url: `${API_HOST}/${API_VER}/utility/deviceIdValidity`,
            method: "GET",
            data: req_data,
            dataType: "json",
        }).done(resp_data => {
            cb(resp_data);
        });
    }
    window.onload = () => {
        let QrkNV_id = "QrkNV";
        let QrkNV_switch_port1 = $(`input[type=radio][name="${QrkNV_id}_switch_port1"]`);
        let QrkNV_switch_port2 = $(`input[type=radio][name="${QrkNV_id}_switch_port2"]`);

        let dev_switch = $(`input[type=radio][name="dev_switch"]`);
        let input_dev_id = $("#dev_id");
        let input_port = $("#port");
        let input_resp_msg = $("#resp_msg");

        let btn_validate = $("#btn_validate");
        let input_valid_msg = $("#valid_msg");

        QrkNV_switch_port1.on("change", function () {
            set_switch(QrkNV_id, 1, $(this).val(), console.log);
        });

        QrkNV_switch_port2.on("change", function () {
            set_switch(QrkNV_id, 2, $(this).val(), console.log);
        });
        function process_switch_response(resp) {
            dev_switch.removeAttr(ATTR_DISABLED);
            if (resp.status === undefined) { // Invalid response
                return;
            }

            console.log(resp);
            switch (resp.status) {
                case 200:
                    input_resp_msg.html("設定開關成功");
                    break;

                case 400:
                    input_resp_msg.html("Bad Request");
                    break;

                case 408:
                    input_resp_msg.html("裝置回應逾時");
                    break;

                case 500:
                    input_resp_msg.html("API伺服器內部發生錯誤");
                    break;

                default:
            }
        }
        dev_switch.on("change", function () {
            if (input_dev_id.val() === "") {
                input_resp_msg.html("Device ID不得為空白");
                return;
            }

            dev_switch.attr(ATTR_DISABLED, ATTR_DISABLED);
            input_resp_msg.html("等待API回應結果");
            set_switch(input_dev_id.val(), input_port.val(), $(this).val(), process_switch_response);
        });

        // verify ssid & device id
        btn_validate.on("click", () => {
            let v_dev_id = $("#valid_dev_id").val();
            let v_ssid = $("#valid_ssid").val();

            if (v_dev_id === "" || v_ssid === "") {
                input_valid_msg.html("Device ID & SSID不可為空");
                return;
            }

            input_valid_msg.html("等待API回應");
            btn_validate.attr(ATTR_DISABLED, ATTR_DISABLED);
            get_device_id_validity(v_dev_id, v_ssid, (resp) => {
                switch (resp.status) {
                    case 200:
                        input_valid_msg.html(`驗證結果: ${resp.valid ? "" : "不"}一致`);
                        break;

                    case 400:
                        input_valid_msg.html("Bad Request");
                        break;

                    case 500:
                        input_valid_msg.html("Server Internal Error");
                        break;
                }

                btn_validate.removeAttr(ATTR_DISABLED);
            });
        });
    }
    let evt_src = new EventSource(`${API_HOST}/${API_VER}/notify`);
    //開關//
    const zoneButton = document.querySelectorAll('.zone-btn');
    // 選取菜單元素
    const zoneMenu = document.querySelectorAll('.zone-menu');
    // 選取事件源元素

    const stateElements = document.getElementById("state");

    // 為每個按鈕添加事件監聽器
    zoneButton.forEach(e => {
        let self = e;

        self.addEventListener('click', () => {
            let zoneButton = self.id;

            if (zoneButton == 'bt1') {
                set_switch(input_dev_id.val(), input_port.val(), $(this).val(), process_switch_response);
            } else if (zoneButton == 'bt2') {
                set_switch(input_dev_id.val(), input_port.val(), $(this).val(), process_switch_response);
            }
            zoneMenu.forEach(f => {
                f.className = '';
            });
            self.className = 'select';
        });
    });
    // 為事件源添加事件監聽器
    evt_src.addEventListener("updated", (ev) => {
        // 解析收到的數據
        dev = JSON.parse(ev.data);
        if (dev.ssid == "wf8011") {
            if (dev.switch[0] == true) {
                document.getElementById("state").textContent = "ON";
                document.getElementById("bt1").classList.add("on");
            } else {
                document.getElementById("state").textContent = "OFF";
                document.getElementById("bt1").classList.remove("on");
            }

            if (dev.switch[1] == true) {
                document.getElementById("state2").textContent = "ON";
                document.getElementById("bt2").classList.add("on");
            } else {
                document.getElementById("state2").textContent = "OFF";
                document.getElementById("bt2").classList.remove("on");
            }
        }


    });

    // const Switch = document.getElementById("switch");

    // Switch.addEventListener("change", function () {
    //     // 當開關狀態改變時，執行某些動作
    //     const newValue = this.checked;  // 取得新的開關狀態值

    //     // 使用 fetch 方法傳送請求到伺服器端
    //     fetch("/update-switch", {
    //         method: "POST",
    //         headers: {
    //             "Content-Type": "application/json"
    //         },
    //         body: JSON.stringify({
    //             device: "wjWXd",
    //             switch: [true, newValue]
    //         })
    //     })
    //         .then(response => response.json())
    //         .then(data => {
    //             console.log(data);
    //         })
    //         .catch(error => {
    //             console.error(error);
    //         });
    // });
    // app.post('/update-switch', function (req, res))

    // // 自定義函數
    // function set_switch(dev_id, port, value, callback) {
    //     // 實現操作開關的功能
    // }

    // function process_switch_response(data) {
    //     // 處理開關操作的回應數據
    // }

    //*跳出視窗*//
    let btn = document.querySelector("#show");
    let infoModal = document.querySelector("#infoModal");
    btn.addEventListener("click", function () {
        infoModal.showModal();
    })

    let close = document.querySelector("#close");
    close.addEventListener("click", function () {
        infoModal.close();
    })
    console.log()
</script>

</html>